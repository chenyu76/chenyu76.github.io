"""
<h2> 文档索引 </h2>

<p style="text-indent: 0;line-height:100%">/root</br>
│</br>
├──<a href="#./About.md"> About </a><br/>
│</br>
├──<a href="#./script.js"> script </a><br/>
│</br>
├──img<br/>
│　　│</br>
│　　└──pixelart<br/>
│　　　　　│</br>
│　　　　　└──<a href="img/pixelart/index.html"> index.html </a><br/>
│</br>
├──测试页<br/>
│　　│</br>
│　　└──<a href="#测试页/equationtest.md"> equationtest </a><br/>
│</br>
├──文章<br/>
│　　│</br>
│　　├──<a href="#文章/关于这个网站.md"> 关于这个网站 </a><br/>
│　　│</br>
│　　├──<a href="#文章/做了一些学校的LaTeX模板.js"> 做了一些学校的LaTeX模板 </a><br/>
│　　│</br>
│　　└──<a href="#文章/关于《十七岁的单车》.md"> 关于《十七岁的单车》 </a><br/>
│</br>
├──摘抄<br/>
│　　│</br>
│　　├──<a href="#摘抄/想象.md"> 想象 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/C99 doesn't need function bodies, or 'VLAs are Turing complete’.md"> C99 doesn't need function bodies, or 'VLAs are Turing complete’ </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/Had I not seen the Sun.md"> Had I not seen the Sun </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/《热风》随感录四十一.md"> 《热风》随感录四十一 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/不要抛弃学问.md"> 不要抛弃学问 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/脸与法治.md"> 脸与法治 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/善人.md"> 善人 </a><br/>
│　　<a href="javascript:void(0);" style="font-size: 80%;line-height:100%" onclick="toggleNextNextVis(this)">显示全部</a></br><span class="hiddenContent">
│　　│</br>
│　　├──<a href="#摘抄/给不安的你.md"> 给不安的你 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/我的戒烟.md"> 我的戒烟 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/最伟大的科幻小说.md"> 最伟大的科幻小说 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/雄辩症.md"> 雄辩症 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/四千三百年.md"> 四千三百年 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/日暮.md"> 日暮 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/-随机一篇-.js"> -随机一篇- </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/软件幻灭.md"> 软件幻灭 </a><br/>
│　　│</br>
│　　├──<a href="#摘抄/一百岁感言.md"> 一百岁感言 </a><br/>
│　　│</br>
│　　└──<a href="#摘抄/琐事.md"> 琐事 </a><br/>
</span>
│</br>
├──program<br/>
│　　│</br>
│　　├──15s-Jan-ken<br/>
│　　│　　│</br>
│　　│　　├──<a href="program/15s-Jan-ken/jan-ken.html"> jan-ken.html </a><br/>
│　　│　　│</br>
│　　│　　└──<a href="#program/15s-Jan-ken/README.md"> README </a><br/>
│　　│</br>
│　　├──<a href="program/counter.html"> counter.html </a><br/>
│　　│</br>
│　　├──TractorBattle3D<br/>
│　　│　　│</br>
│　　│　　├──<a href="#program/TractorBattle3D/readme.md"> readme </a><br/>
│　　│　　│</br>
│　　│　　└──<a href="program/TractorBattle3D/tb.html"> tb.html </a><br/>
│　　<a href="javascript:void(0);" style="font-size: 80%;line-height:100%" onclick="toggleNextNextVis(this)">显示全部</a></br><span class="hiddenContent">
│　　│</br>
│　　├──skipping-classes-for-introduction-to-entrepreneurship-for-the-future<br/>
│　　│　　│</br>
│　　│　　└──<a href="program/skipping-classes-for-introduction-to-entrepreneurship-for-the-future/index.html"> index.html </a><br/>
│　　│</br>
│　　├──WheelOfFortune<br/>
│　　│　　│</br>
│　　│　　├──<a href="#program/WheelOfFortune/readme.md"> readme </a><br/>
│　　│　　│</br>
│　　│　　└──<a href="program/WheelOfFortune/WheelOfFortune.html"> WheelOfFortune.html </a><br/>
│　　│</br>
│　　├──colliding_balls<br/>
│　　│　　│</br>
│　　│　　└──<a href="program/colliding_balls/cb.html"> cb.html </a><br/>
│　　│</br>
│　　└──7-piece-puzzle<br/>
│　　　　　│</br>
│　　　　　├──<a href="program/7-piece-puzzle/puzzle.html"> puzzle.html </a><br/>
│　　　　　│</br>
│　　　　　└──<a href="#program/7-piece-puzzle/Readme and solution.md"> Readme and solution </a><br/>
</span>
│</br>
├──<a href="./index.html"> index.html </a><br/>
│</br>
└──<a href="#./README.md"> README </a><br/></p>

<h2> 推荐内容 </h2>
<ul>
<li><a href="#program/7-piece-puzzle/Readme and solution.md">一个拼图游戏</a> <small>(09 September 2024)</small> </li>
<li><a href="#program/TractorBattle3D/readme.md">生成障碍阻碍对手的多人本地游戏</a> <small>(August 2024)</small> </li>
<li><a href="#摘抄/-随机一篇-.js">看看随机一篇摘抄</a> <small>(----)</small> </li>
<li><a href="#文章/做了一些学校的LaTeX模板.js">做了一些学校的LaTeX模板</a> <small>(August 2024)</small> </li>
<li><a href="#文章/关于这个网站.md">关于这个网站</a> <small>(20 June 2024)</small> </li>
</ul>
<!--"""

# 执行此python文件以更新上面的目录
import os
from datetime import datetime
import recommend

clickable_extension = [".md", ".txt", ".tex", ".html", ".js"]  # 菜单中可点击的文件后缀
article_extension = [".md", ".js"]  # 视为文章的文件后缀


# 创建文件目录树
def folder_tree(path, depth=0, startpath=None, line_d=0):
    table = []
    items = os.listdir(path)
    items = [
        s
        for s in items
        if (os.path.isdir(os.path.join(path, s)) and (not s.startswith(".")))
        or (
            os.path.isfile(os.path.join(path, s))
            and any([s.endswith(x) for x in clickable_extension])
        )
    ]
    # 排除掉 program 等 文件夹里的 js
    items = [
        i
        for i in items
        if not (
            i.split(".")[-1] == "js"
            and ("program" in path or "img" in path or "libs" in path)
        )
    ]

    def item_to_button():
        rpath = os.path.relpath(
            (startpath if startpath else path), startpath
        )  # 相对路径
        withSharp = False
        for ex in article_extension:  # 这些视为文章
            if item.endswith(ex):
                withSharp = True
                table.append(
                    style
                    + f'<a href="#{os.path.join(rpath, item)}"> {item.rstrip(ex)} </a><br/>'
                )
                break
        if not withSharp:  # 其余仅为可点击项
            table.append(
                style + f'<a href="{os.path.join(rpath, item)}"> {item} </a><br/>'
            )

    for index, item in enumerate(items):
        is_last = index == len(items) - 1
        s = ""
        line = line_d
        for _ in range(depth):
            s += "│　　" if line & 1 else "　　　"
            line >>= 1
        style = s + "│</br>\n" + s + ("└──" if is_last else "├──")
        # 根据特定规则将文件视为文章或者直接打开，并创建不同的<a>标签
        # 这是一个目录，递归调用
        if os.path.isdir(os.path.join(path, item)):
            # item 的子项是t
            t = folder_tree(
                os.path.join(path, item),
                depth + 1,
                startpath,
                (0 if is_last else 1 << depth) + line_d,
            )
            # 有内容才显示，
            if len(t):
                table.append(style + item + "<br/>")
                # 太长了就插入显示全部按钮
                if len(t) > 10:
                    # 这里的s是本次递归调用的s,但其实应该插入 下一次递归调用时的s,但目前没有什么大问题先使用临时解决方案
                    t.insert(
                        7,
                        s
                        + "│　　"
                        + s
                        + """<a href="javascript:void(0);" style="font-size: 80%;line-height:100%" onclick="toggleNextNextVis(this)">显示全部</a></br><span class="hiddenContent">""",
                    )
                    t.append("</span>")
                table += t
        # 这是一个文件，判断是否显示
        else:
            item_to_button()
    return table


def generate_recommand(recommend):
    list = []
    for i in recommend:
        if i["date"] > 10000000:
            i["date"] = datetime.strptime(str(i["date"]), "%Y%m%d").strftime("%d %B %Y")
        elif i["date"] > 100000:
            i["date"] = datetime.strptime(str(i["date"]), "%Y%m").strftime("%B %Y")
        elif i["date"] > 100000:
            i["date"] = datetime.strptime(str(i["date"]), "%m%d").strftime("%d %B")
        else:
            i["date"] = "----"
        list.append(
            "<li>"
            + f'<a href="#{i["link"]}">'
            + (
                i["link"].split(".")[-2].split("/")[-1]
                if "info" not in i.keys()
                else i["info"]
            )
            + "</a> <small>("
            + i["date"]
            + ")</small> </li>"
        )

    return "<ul>\n" + "\n".join(list) + "\n</ul>"


# 生成 “随机一篇” 的可用文章
def random_article_js_g(path, dir_path):
    # 读取原始文件内容
    with open(path, "r", encoding="utf-8") as file:
        content = file.read()

    start_tag = "//begin"
    end_tag = "//end"
    current_dir = os.path.dirname(path)
    artc = []
    for root, dirs, files in os.walk(current_dir):
        # 排除隐藏目录
        dirs = [d for d in dirs if not d.startswith(".")]
        # 获取非隐藏的Markdown文件
        for file in files:
            if file.endswith(".md") and not file.startswith("."):
                artc.append('"#' + dir_path + file + '"')
    start_idx = content.find(start_tag) + len(start_tag)
    end_idx = content.find(end_tag)
    # 写回修改后的内容到文件
    with open(path, "w", encoding="utf-8") as file:
        file.write(content[:start_idx] + ",\n".join(artc) + content[end_idx:])


# r = '<p style="line-height:200%"></br>\n' + '</br>\n'.join([f'{i[1]} <a href="#{i[0]}"> {i[0]} </a>' for i in find_recent_markdown_files()]) + "</p>\n"
def rewrite_self():
    # 树
    t = (
        '\n<p style="text-indent: 0;line-height:100%">/root</br>\n'
        + "\n".join(folder_tree(os.path.dirname(os.path.abspath(__file__))))
        + "</p>\n"
    )
    # 推荐
    r = generate_recommand(recommend.recommend)
    # 读取原始文件内容
    with open(__file__, "r", encoding="utf-8") as file:
        content = file.read()

    start_tag = "\"\"\""
    end_tag = "<!--"
    start_idx = content.find(start_tag) + len(start_tag)
    end_idx = content.find(end_tag)
    # 写回修改后的内容到文件
    with open(__file__, "w", encoding="utf-8") as file:
        file.write(
            content[:start_idx]
            + "\n<h2> 文档索引 </h2>\n"
            + t
            + "\n<h2> 推荐内容 </h2>\n"
            + r
            + "\n"
            + content[end_idx:]
        )


if __name__ == "__main__":
    rewrite_self()
    jspath = os.path.join(
        os.path.dirname(os.path.abspath(__file__)), "摘抄/-随机一篇-.js"
    )
    random_article_js_g(jspath, "摘抄/")
# -->
